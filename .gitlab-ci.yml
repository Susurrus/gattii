image: "scorpil/rust:stable"

stages:
    - build
    - test

variables:
    CARGO_HOME: $CI_PROJECT_DIR/cargo

cache:
    paths:
        - cargo/

before_script:
    - apt-get -qq update && apt-get -qq -y install libudev-dev libgtk-3-dev

build-debug:
    stage: build
    script:
        - rustc --version && cargo --version # Print version info for debugging
        - cargo build --verbose

build-release:
    stage: build
    script:
        - rustc --version && cargo --version # Print version info for debugging
        - cargo build --verbose --release

test:
    stage: test
    script:
        - rustc --version && cargo --version # Print version info for debugging
        - cargo test --verbose --jobs 1 --release # Don't parallelize to make errors more readable
        - cargo install rustfmt || true
        - export PATH=$PATH:~/.cargo/bin
        - cargo fmt -- --write-mode=diff
